<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Reclamos</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/vfs_fonts.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      padding: 20px;
      background: #eef1f5;
      color: #333;
      line-height: 1.6;
    }
    #appContainer {
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .controls-bar {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    #excelTable {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: 6px;
      overflow: hidden;
    }
    #excelTable th,
    #excelTable td {
      border: 1px solid #dfe3e8;
      padding: 10px 12px;
      vertical-align: middle;
      font-size: 14px;
      /* For auto-adjusting width, avoid fixed min-width or use small ones */
      /* min-width: 140px; */ /* Removed for more fluid auto-width */
      width: auto; /* Allow browser to determine width */
    }
    #excelTable th {
      background-color: #f8f9fa;
      color: #495057;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
      text-align: center;
    }
    #excelTable td {
      text-align: left;
    }
    #excelTable td input[type="number"], /* Center numbers within cells */
    #excelTable td input[data-format-cuil] {
        text-align: right; /* Align CUIL/CUIT and numbers to right for readability */
    }
    #excelTable tbody tr:hover {
      background-color: #f1f3f5;
    }
    select,
    input[type="date"],
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      box-sizing: border-box;
      text-align: left;
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      vertical-align: middle;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
      padding-right: 2.5rem;
    }
    input[type="number"] { max-width: 120px;}
    select:focus,
    input:focus,
    textarea:focus {
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    textarea {
      resize: vertical;
      min-height: 40px;
      line-height: 1.5;
    }
    button {
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid transparent;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      background-color: #007bff;
      color: white;
      white-space: nowrap; /* Prevent button text from wrapping */
    }
    button:hover {
      background-color: #0056b3;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button:active {
      background-color: #004085;
    }
    #addRowButton { background-color: #28a745; }
    #addRowButton:hover { background-color: #1e7e34; }
    #addAgenteSaludButton { background-color: #17a2b8; } /* Teal for new button */
    #addAgenteSaludButton:hover { background-color: #117a8b; }
    #notifyButton { background-color: #6c757d; }
    #notifyButton:hover { background-color: #545b62; }
    .action-cell {
      min-width: 80px !important; /* Keep action cell width fixed */
      width: 90px !important;
      text-align: center !important;
    }
    .action-cell button {
      background-color: #dc3545;
      padding: 6px 10px;
      font-size: 13px;
    }
    .action-cell button:hover {
      background-color: #b02a37;
    }
    #reclamoInput {
      padding: 9px 10px;
    }
  </style>
</head>
<body>
<div id="appContainer">
  <div class="controls-bar">
    <button id="addRowButton">Agregar Fila</button>
    <input type="number" id="reclamoInput" placeholder="Nº Reclamo" />
    <button id="addAgenteSaludButton">Agregar Agente de Seguro de Salud</button>
    <button id="notifyButton">Estado del Reclamo</button>
    </div>
  <div style="overflow-x: auto;">
    <table id="excelTable">
      <thead>
        <tr>
          <th class="action-cell">ACCIÓN</th>
          <th>EXPEDIENTE</th><th>RECLAMO</th><th>TIEMPO</th><th>TIPO DE TRÁMITE</th><th>ESTADO</th><th>FECHA INICIO</th>
          <th>NOMBRE Y APELLIDO</th><th>CUIL</th>
          <th>OBRA SOCIAL</th><th>RNAS</th><th>CUITRNAS</th>
          <th>EMPRESA</th><th>RNEMP</th><th>CUITRNEMP</th>
          <th>MAIL BENEFICIARIO</th><th>ÚLTIMA ACCIÓN</th>
          <th>DÍAS</th>
          <th>DETALLE INFORME</th><th>DOCUMENTACIÓN</th>
          <th>INFORME MÉDICO</th><th>INFORME CONTABLE</th>
          <th>TIPO DE BENEFICIARIO</th><th>DERIVA APORTES</th>
          <th>PRESENTACION BENEF</th>
          <th>NOMBRE, APELLIDO Y CUIL DEL FAMILIAR</th>
          <th>DESCARGO OS/EMP</th>
          <th>INFORME DESCARGO</th><th>SEGUNDA INSTANCIA BENEFICIARIO</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const table = document.getElementById('excelTable').getElementsByTagName('tbody')[0];
  const notifyButton = document.getElementById('notifyButton');
  const reclamoInput = document.getElementById('reclamoInput');
  const addAgenteSaludButton = document.getElementById('addAgenteSaludButton');

  // --- DATA FOR AUTOCOMPLETION ---
  // Load from localStorage or use defaults
  let obrasSocialesData = JSON.parse(localStorage.getItem('obrasSocialesData')) || [
    // Example: { rnas: "100201", nombre: "OBRA SOCIAL DE EJEMPLO UNO", cuit: "30-12345678-9" },
    // Example: { rnas: "100202", nombre: "OS DOS EJEMPLO", cuit: "30-23456789-0" }
    // *** INSERT YOUR OBRAS SOCIALES DATA HERE ***
    { rnas: "000001", nombre: "OS Ejemplo 1 (Precargada)", cuit: "30000000001" },
    { rnas: "000002", nombre: "OS Ejemplo 2 (Precargada)", cuit: "30000000002" }
  ];

  let empresasData = JSON.parse(localStorage.getItem('empresasData')) || [
    // Example: { rnemp: "200101", nombre: "EMPRESA EJEMPLO ABC", cuit: "33-01234567-8" },
    // Example: { rnemp: "200102", nombre: "COMPANIA XYZ DE PRUEBA", cuit: "33-10987654-7" }
    // *** INSERT YOUR EMPRESAS DATA HERE ***
    { rnemp: "900001", nombre: "Empresa Ejemplo A (Precargada)", cuit: "33000000001" },
    { rnemp: "900002", nombre: "Empresa Ejemplo B (Precargada)", cuit: "33000000002" }
  ];

  const TIEMPO_OPTIONS = [
    { value: "10", text: "Diez (10)" }, { value: "5", text: "Cinco (5)" }, { value: "2", text: "Dos (2)" }
  ];
  const TIPO_BENEFICIARIO_OPTIONS = [
    "Relación de Dependencia", "Monotributista", "Monotributista Social",
    "Empleada Servicio Doméstico", "Prepaga Beneficiario", "Pasivo", "Desempleo"
  ];
  const DERIVA_APORTES_OPTIONS = ["SI", "NO"];
  const PRESENTACION_BENEF_OPTIONS = [
    "Por derecho propio (solo)", "En representación de su grupo familiar"
  ];
  const DESCARGO_OSEMP_OPTIONS = [
    "Presenta descargo", "No presenta descargo pese a estar notificado"
  ];
  const estadosDropdown = [
    'FALTA DOCUMENTACION', 'IF A FIRMA', 'IF MEDICO ( GDYAISS#SSS – INFORMESMEDICOS )',
    'IF CONTABLE ( GDYAISS#SSS – INFORMESCONTABLES )', 'NOTIFICADOS: ( OS / EMP )',
    'RESPUESTA A BENEFICIARIO', 'NOTIF DESPACHO (SG#SSS – DESPACHO)', 'SD#SSS – AJU',
    'GUARDA TEMPORAL', 'DISCAPCIDAD ( SGSUSSS - ATD )', 'SG#SSS – ARCHIVO',
    'CONSULTAR A FIRMA', 'INFORMATICA'
  ];
  const statusColors = {
    'FALTA DOCUMENTACION': { bg: '#FFFFE0', text: '#000000' },'IF A FIRMA': { bg: '#b3e5fc', text: '#000000' },
    'IF MEDICO ( GDYAISS#SSS – INFORMESMEDICOS )': { bg: '#FAFAD2', text: '#000000' }, 'IF CONTABLE ( GDYAISS#SSS – INFORMESCONTABLES )': { bg: '#FAFAD2', text: '#000000' },
    'NOTIFICADOS: ( OS / EMP )': { bg: '#90EE90', text: '#000000' },'RESPUESTA A BENEFICIARIO': { bg: '#FFA500', text: '#000000' },
    'NOTIF DESPACHO (SG#SSS – DESPACHO)': { bg: '#D3D3D3', text: '#000000' },'SD#SSS – AJU': { bg: '#A9A9A9', text: '#000000' },
    'GUARDA TEMPORAL': { bg: '#000000', text: '#FF0000' },'DISCAPCIDAD ( SGSUSSS - ATD )': { bg: '#D2B48C', text: '#000000' },
    'SG#SSS – ARCHIVO': { bg: '#FFFFFF', text: '#000000' },'CONSULTAR A FIRMA': { bg: '#FF0000', text: '#FFFFFF' },
    'INFORMATICA': { bg: '#ADD8E6', text: '#808080' }
  };

  const NUM_DATA_COLUMNS_OLD = 23; // For migration
  const NUM_DATA_COLUMNS = 28; // Old 23 - 1 (OS/EMP) + 6 (new OS/EMP fields) = 28
  
  // Original indices: 12, 13, 14, 15, 19, 21 (referring to data_idx)
  // OS/EMP was at data_idx 8. It's replaced by 6 columns (new data_idx 8 to 13).
  // So, columns from original data_idx 9 onwards are shifted by +5.
  // old 12 (DETALLE INFORME) -> new data_idx 17
  // old 13 (DOCUMENTACIÓN) -> new data_idx 18
  // old 14 (INFORME MÉDICO) -> new data_idx 19
  // old 15 (INFORME CONTABLE) -> new data_idx 20
  // old 19 (NOMBRE FAMILIAR) -> new data_idx 24
  // old 21 (INFORME DESCARGO) -> new data_idx 26
  const textareaDataIndices = [17, 18, 19, 20, 24, 26];

  document.getElementById('addRowButton').addEventListener('click', () => {
    addRow(new Array(NUM_DATA_COLUMNS).fill(""));
    saveToLocalStorage();
  });

  notifyButton.addEventListener('click', function () {
    handleReclamoAction(generateSimpleNotificationPdf);
  });
  
  addAgenteSaludButton.addEventListener('click', function() {
    const tipoAgente = prompt("Ingrese el tipo de agente a agregar ('OS' para Obra Social, 'EMP' para Empresa):")?.toUpperCase();
    if (!tipoAgente || (tipoAgente !== 'OS' && tipoAgente !== 'EMP')) {
        alert("Tipo de agente no válido. Debe ser 'OS' o 'EMP'.");
        return;
    }

    const rnasOrRnemp = prompt(`Ingrese el ${tipoAgente === 'OS' ? 'RNAS' : 'RNEMP'}:`);
    if (!rnasOrRnemp) { alert("El RNAS/RNEMP no puede estar vacío."); return; }

    const nombre = prompt("Ingrese el Nombre completo del agente:");
    if (!nombre) { alert("El nombre no puede estar vacío."); return; }
    
    const cuit = prompt("Ingrese el CUIT (sin guiones, solo números):");
    if (!cuit || !/^\d{11}$/.test(cuit.replace(/\D/g,''))) { alert("CUIT inválido. Debe contener 11 dígitos."); return; }

    if (tipoAgente === 'OS') {
        if (obrasSocialesData.find(os => os.rnas === rnasOrRnemp)) {
            alert("Ya existe una Obra Social con ese RNAS.");
            return;
        }
        obrasSocialesData.push({ rnas: rnasOrRnemp, nombre: nombre, cuit: cuit.replace(/\D/g,'') });
        localStorage.setItem('obrasSocialesData', JSON.stringify(obrasSocialesData));
        alert("Obra Social agregada y guardada.");
    } else if (tipoAgente === 'EMP') {
        if (empresasData.find(emp => emp.rnemp === rnasOrRnemp)) {
            alert("Ya existe una Empresa con ese RNEMP.");
            return;
        }
        empresasData.push({ rnemp: rnasOrRnemp, nombre: nombre, cuit: cuit.replace(/\D/g,'') });
        localStorage.setItem('empresasData', JSON.stringify(empresasData));
        alert("Empresa agregada y guardada.");
    }
  });

  function handleReclamoAction(actionCallback) {
    const reclamoNumber = reclamoInput.value.trim();
    if (!reclamoNumber) return alert("Ingrese un número de reclamo.");

    const rows = Array.from(table.rows);
    const targetRow = rows.find(row => {
      const inputElement = row.cells[2]?.querySelector('input, textarea, select'); // RECLAMO is at cell_idx 2
      return inputElement && inputElement.value === reclamoNumber;
    });

    if (!targetRow) return alert("No se encontró el reclamo.");
    
    const rowDataArray = Array.from(targetRow.cells).slice(1, NUM_DATA_COLUMNS + 1).map((cell, data_idx_relative) => {
      // DÍAS is at new data_idx 16 (cell_idx 17)
      if (data_idx_relative === 16) { 
        return cell.textContent;
      }
      const input = cell.querySelector('input, select, textarea');
      return input ? input.value : "";
    });
    
    // Map to new data structure
    const reclamoData = {
      expediente: rowDataArray[0], reclamo: rowDataArray[1], tiempo: rowDataArray[2], tipoTramite: rowDataArray[3],
      estado: rowDataArray[4], fechaInicio: rowDataArray[5], nombreApellido: rowDataArray[6], cuil: rowDataArray[7],
      // New OS/EMP fields
      obraSocial: rowDataArray[8], rnas: rowDataArray[9], cuitRnas: rowDataArray[10],
      empresa: rowDataArray[11], rnemp: rowDataArray[12], cuitRnemp: rowDataArray[13],
      // Shifted fields
      mailBeneficiario: rowDataArray[14], ultimaAccion: rowDataArray[15], dias: rowDataArray[16], 
      detalleInforme: rowDataArray[17], documentacion: rowDataArray[18], informeMedico: rowDataArray[19], 
      informeContable: rowDataArray[20], tipoBeneficiario: rowDataArray[21], derivaAportes: rowDataArray[22], 
      presentacionBenef: rowDataArray[23], nombreFamiliar: rowDataArray[24], descargoOSEMP: rowDataArray[25], 
      informeDescargo: rowDataArray[26], segundaInstanciaBenef: rowDataArray[27]
    };
    actionCallback(reclamoData);
  }
 
  function generateSimpleNotificationPdf(data) {
    let displayEstado = data.estado;
    if (data.estado && data.estado.includes('(')) {
      displayEstado = data.estado.substring(0, data.estado.indexOf('(')).trim();
    }
    if (!displayEstado) displayEstado = "(Sin estado)";

    const docDefinition = {
      content: [
        {
          text: [
            'Estimado, ',
            { text: data.nombreApellido || '(Sin nombre y apellido)', bold: true }
          ]
        },
        { text: ' ', margin: [0, 10] },
        {
          text: [
            'Le informamos que el estado de su reclamo es: ',
            { text: displayEstado, bold: true },
            '.'
          ]
        },
        { text: ' ', margin: [0, 10] },
        {
          text: [
            'Para cualquier consultar o descargo que desee realizar sobre el expediente (',
            { text: data.expediente || '(Sin expediente)', bold: true },
            '), debe realizarlo en el sig. link oficial: https://www.argentina.gob.ar/sssalud/centro-de-atencion-virtual'
          ]
        },
        { text: ' ', margin: [0, 20] },
        { text: 'Saludos atte.' }
      ],
      defaultStyle: {
        fontSize: 11,
        lineHeight: 1.4,
        font: 'Roboto'
      }
    };
    pdfMake.createPdf(docDefinition).download(`Notificacion_Reclamo_${data.reclamo || 'SIN_NUM'}.pdf`);
  }

  function createSelectWithOptions(optionsArray, selectedValue, isObjectList = false) {
    const select = document.createElement('select');
    const placeholderOption = document.createElement('option');
    placeholderOption.value = ""; placeholderOption.textContent = "Seleccione..."; select.appendChild(placeholderOption);
    optionsArray.forEach(opt => {
      const option = document.createElement('option');
      if (isObjectList) { option.value = opt.value; option.textContent = opt.text; } 
      else { option.value = opt; option.textContent = opt; }
      select.appendChild(option);
    });
    select.value = selectedValue || ""; select.addEventListener('change', saveToLocalStorage);
    return select;
  }
 
  function addRow(rowData = []) {
    const row = table.insertRow(0);
    for (let cell_idx = 0; cell_idx < NUM_DATA_COLUMNS + 1; cell_idx++) {
      const cell = row.insertCell(cell_idx);
      let data_idx = cell_idx - 1; // This is the index within rowData array

      if (cell_idx === 0) { // ACCIÓN
        const deleteButton = document.createElement('button'); deleteButton.textContent = 'Eliminar';
        deleteButton.addEventListener('click', function() { row.remove(); saveToLocalStorage(); });
        cell.appendChild(deleteButton); cell.classList.add('action-cell');
      } else if (cell_idx === 3) { // TIEMPO (data_idx 2)
        cell.appendChild(createSelectWithOptions(TIEMPO_OPTIONS, rowData[data_idx], true));
      } else if (cell_idx === 5) { // ESTADO (data_idx 4)
        const select = createSelectWithOptions(estadosDropdown, rowData[data_idx]);
        select.removeEventListener('change', saveToLocalStorage); // Remove default, add custom
        select.addEventListener('change', () => { applyRowColor(row, select.value); saveToLocalStorage(); });
        cell.appendChild(select);
      } else if (cell_idx === 6) { // FECHA INICIO (data_idx 5)
        const input = document.createElement('input'); input.type = 'date'; input.value = rowData[data_idx] || "";
        input.addEventListener('input', saveToLocalStorage); cell.appendChild(input);
      } else if (cell_idx === 8) { // CUIL (data_idx 7)
        const input = document.createElement('input'); input.type = 'text'; input.placeholder = "XX-XXXXXXXX-X";
        input.dataset.formatCuil = true; // Marker for styling
        input.value = rowData[data_idx] ? formatCUIL(String(rowData[data_idx])) : "";
        input.addEventListener('input', function () { this.value = this.value.replace(/\D/g, ''); });
        input.addEventListener('blur', function () { this.value = formatCUIL(this.value); saveToLocalStorage(); });
        cell.appendChild(input);
      
      // New OS/EMP columns: cell_idx 9 to 14 (data_idx 8 to 13)
      } else if (cell_idx === 9) { // OBRA SOCIAL (data_idx 8) - Text input, populated by RNAS
        const input = document.createElement('input'); input.type = 'text'; input.value = rowData[data_idx] || "";
        input.readOnly = true; // Made readonly, populated by RNAS change
        input.addEventListener('input', saveToLocalStorage); cell.appendChild(input);
      } else if (cell_idx === 10) { // RNAS (data_idx 9) - Input that triggers autocompletion
        const input = document.createElement('input'); input.type = 'text'; input.value = rowData[data_idx] || "";
        input.placeholder = "RNAS";
        input.addEventListener('change', function() { // Use change instead of input for performance
            const rnasValue = this.value.trim();
            const os = obrasSocialesData.find(o => o.rnas === rnasValue);
            const osNombreInput = row.cells[9].querySelector('input'); // OBRA SOCIAL cell
            const cuitRnasInput = row.cells[11].querySelector('input'); // CUITRNAS cell
            if (os) {
                if(osNombreInput) osNombreInput.value = os.nombre;
                if(cuitRnasInput) cuitRnasInput.value = formatCUIL(os.cuit);
            } else {
                if(osNombreInput) osNombreInput.value = "";
                if(cuitRnasInput) cuitRnasInput.value = "";
            }
            saveToLocalStorage();
        });
        input.addEventListener('input', saveToLocalStorage); // Still save on general input
        cell.appendChild(input);
      } else if (cell_idx === 11) { // CUITRNAS (data_idx 10) - Text input, populated by RNAS, formatted
        const input = document.createElement('input'); input.type = 'text'; input.placeholder = "XX-XXXXXXXX-X";
        input.dataset.formatCuil = true;
        input.readOnly = true; // Made readonly
        input.value = rowData[data_idx] ? formatCUIL(String(rowData[data_idx])) : "";
        // Value set by RNAS change, formatting applied there. Blur listener for manual edits if not readonly.
        input.addEventListener('input', saveToLocalStorage); 
        cell.appendChild(input);
      } else if (cell_idx === 12) { // EMPRESA (data_idx 11) - Text input, populated by RNEMP
        const input = document.createElement('input'); input.type = 'text'; input.value = rowData[data_idx] || "";
        input.readOnly = true; // Made readonly
        input.addEventListener('input', saveToLocalStorage); cell.appendChild(input);
      } else if (cell_idx === 13) { // RNEMP (data_idx 12) - Input that triggers autocompletion
        const input = document.createElement('input'); input.type = 'text'; input.value = rowData[data_idx] || "";
        input.placeholder = "RNEMP";
        input.addEventListener('change', function() {
            const rnempValue = this.value.trim();
            const emp = empresasData.find(e => e.rnemp === rnempValue);
            const empNombreInput = row.cells[12].querySelector('input'); // EMPRESA cell
            const cuitRnempInput = row.cells[14].querySelector('input'); // CUITRNEMP cell
            if (emp) {
                if(empNombreInput) empNombreInput.value = emp.nombre;
                if(cuitRnempInput) cuitRnempInput.value = formatCUIL(emp.cuit);
            } else {
                if(empNombreInput) empNombreInput.value = "";
                if(cuitRnempInput) cuitRnempInput.value = "";
            }
            saveToLocalStorage();
        });
        input.addEventListener('input', saveToLocalStorage);
        cell.appendChild(input);
      } else if (cell_idx === 14) { // CUITRNEMP (data_idx 13) - Text input, populated by RNEMP, formatted
        const input = document.createElement('input'); input.type = 'text'; input.placeholder = "XX-XXXXXXXX-X";
        input.dataset.formatCuil = true;
        input.readOnly = true; // Made readonly
        input.value = rowData[data_idx] ? formatCUIL(String(rowData[data_idx])) : "";
        input.addEventListener('input', saveToLocalStorage);
        cell.appendChild(input);

      // Shifted columns due to OS/EMP expansion
      } else if (cell_idx === 16) { // ÚLTIMA ACCIÓN (data_idx 15)
        const input = document.createElement('input'); input.type = 'date'; input.value = rowData[data_idx] || "";
        input.addEventListener('change', function () { updateDays(row, input.value); });
        input.addEventListener('input', () => { if(!input.value) updateDays(row, input.value); });
        cell.appendChild(input);
      } else if (cell_idx === 17) { // DÍAS (data_idx 16)
        cell.textContent = rowData[data_idx] || "0"; cell.style.textAlign = 'center';
      } else if (cell_idx === 22) { // TIPO DE BENEFICIARIO (data_idx 21)
        cell.appendChild(createSelectWithOptions(TIPO_BENEFICIARIO_OPTIONS, rowData[data_idx]));
      } else if (cell_idx === 23) { // DERIVA APORTES (data_idx 22)
        cell.appendChild(createSelectWithOptions(DERIVA_APORTES_OPTIONS, rowData[data_idx]));
      } else if (cell_idx === 24) { // PRESENTACION BENEF (data_idx 23)
        cell.appendChild(createSelectWithOptions(PRESENTACION_BENEF_OPTIONS, rowData[data_idx]));
      } else if (cell_idx === 26) { // DESCARGO OS/EMP (data_idx 25)
        cell.appendChild(createSelectWithOptions(DESCARGO_OSEMP_OPTIONS, rowData[data_idx]));
      
      } else if (textareaDataIndices.includes(data_idx)) {
        const textarea = document.createElement('textarea'); textarea.rows = 1; 
        textarea.value = rowData[data_idx] || "";
        textarea.addEventListener('input', saveToLocalStorage); cell.appendChild(textarea);
      } else { 
        const input = document.createElement('input');
        // RECLAMO is at cell_idx 2 (data_idx 1)
        if (cell_idx === 2 && rowData[data_idx] !== null && rowData[data_idx] !== undefined && !isNaN(parseFloat(rowData[data_idx])) && isFinite(rowData[data_idx])) {
          input.type = 'number'; input.style.textAlign = 'right';
        } else {
          input.type = 'text';
        }
        input.value = rowData[data_idx] || "";
        input.addEventListener('input', saveToLocalStorage); cell.appendChild(input);
      }
    }
    const estadoActual = row.cells[5].querySelector('select').value; // ESTADO is cell_idx 5
    applyRowColor(row, estadoActual);

    // Trigger autocompletion for existing RNAS/RNEMP values if present when row is added (e.g. from localStorage)
    const rnasInput = row.cells[10]?.querySelector('input'); // RNAS cell
    if (rnasInput && rnasInput.value) {
        const event = new Event('change'); // Create a new event
        rnasInput.dispatchEvent(event);   // Dispatch it
    }
    const rnempInput = row.cells[13]?.querySelector('input'); // RNEMP cell
    if (rnempInput && rnempInput.value) {
        const event = new Event('change');
        rnempInput.dispatchEvent(event);
    }
    
    // ÚLTIMA ACCIÓN is cell_idx 16, DÍAS is cell_idx 17
    if (row.cells[16]?.querySelector('input')) { 
        updateDays(row, row.cells[16].querySelector('input').value);
    } else { 
        updateDays(row, ""); 
    }
  }

  function formatCUIL(value) {
    const digits = String(value).replace(/\D/g, '');
    if (digits.length === 11) return `${digits.substring(0, 2)}-${digits.substring(2, 10)}-${digits.substring(10)}`;
    return digits || value; 
  }

  function updateDays(row, lastActionDate) {
    const daysCell = row.cells[17]; // DÍAS is now at cell_idx 17
    if (!daysCell) return;
    if (!lastActionDate) { daysCell.textContent = "0"; saveToLocalStorage(); return; }
    const today = new Date(); today.setHours(0,0,0,0); 
    const parts = lastActionDate.split('-'); const lastAction = new Date(parts[0], parts[1] - 1, parts[2]);
    lastAction.setHours(0,0,0,0);
    if (isNaN(lastAction.getTime())) { daysCell.textContent = "0"; saveToLocalStorage(); return; }
    const diff = Math.floor((today - lastAction) / (1000 * 60 * 60 * 24));
    daysCell.textContent = diff >= 0 ? diff : "0"; saveToLocalStorage(); 
  }

  function applyRowColor(row, estado) {
    const colorInfo = statusColors[estado];
    const bgColor = colorInfo ? colorInfo.bg : ''; const textColor = colorInfo ? colorInfo.text : '#000000'; 
    Array.from(row.cells).forEach((cell, cell_idx) => {
      if (cell_idx === 0) { return; } 
      cell.style.backgroundColor = bgColor; cell.style.color = textColor;
      if (cell_idx === 17) cell.style.textAlign = 'center'; // DÍAS is cell_idx 17
    });
  }

  function saveToLocalStorage() {
    const rowsData = Array.from(table.rows).map(row => {
      return Array.from(row.cells).slice(1, NUM_DATA_COLUMNS + 1).map((cell, data_idx_relative) => {
        // DÍAS is at new data_idx 16
        if (data_idx_relative === 16) return cell.textContent;
        const input = cell.querySelector('input, select, textarea');
        return input ? input.value : "";
      });
    });
    localStorage.setItem('tablaReclamos', JSON.stringify(rowsData));
  }

  function loadFromLocalStorage() {
    const dataFromStorage = JSON.parse(localStorage.getItem('tablaReclamos') || '[]');
    dataFromStorage.forEach(storedRowData => {
      let migratedRowData = [...storedRowData];
      // Handle migration from old structure (23 columns) to new (28 columns)
      // The old "OBRA SOCIAL / EMPRESA" was at data_idx 8.
      // It's being replaced by 6 new columns (OBRA SOCIAL, RNAS, CUITRNAS, EMP, RNEMP, CUITRNEMP).
      if (migratedRowData.length === NUM_DATA_COLUMNS_OLD) { // If it's old data structure (23 items)
          const oldOS EMPValue = migratedRowData[8]; // Get the value from old combined field
          const beforeOSEMP = migratedRowData.slice(0, 8);
          const afterOSEMP = migratedRowData.slice(9);
          // New structure: [OBRA SOCIAL (from old), RNAS, CUITRNAS, EMP, RNEMP, CUITRNEMP]
          // We'll put the old value in the 'OBRA SOCIAL' field, and leave others blank for user to fill/autocomplete.
          migratedRowData = [
              ...beforeOSEMP,
              oldOS EMPValue, "", "", "", "", "", // OBRA SOCIAL (populated), RNAS, CUITRNAS, EMP, RNEMP, CUITRNEMP (blank)
              ...afterOSEMP
          ];
      }
      // A previous migration rule, ensure it's compatible or remove if not needed.
      // This was to insert a column at index 13 if length was 22.
      // Given the new migration, this might need adjustment or might have been for a temporary state.
      // For safety, let's comment it out or adapt. If new length is 28, this won't trigger.
      /*
      if (adjustedRowData.length === 22) { 
         adjustedRowData.splice(13, 0, ""); 
      }
      */

      if (migratedRowData.length === NUM_DATA_COLUMNS) {
          addRow(migratedRowData);
      } else {
          console.warn("Datos con longitud incorrecta en localStorage. Esperado:",
          NUM_DATA_COLUMNS, "Obtenido:", migratedRowData.length, storedRowData);
          // Optionally, try to pad or truncate if a consistent pattern of error is known.
          // For now, just log and skip to avoid breaking the table.
      }
    });
  }
  loadFromLocalStorage();
});
</script>
</body>
</html>
